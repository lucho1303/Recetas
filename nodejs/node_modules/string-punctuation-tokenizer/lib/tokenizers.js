"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.classifyTokens = exports.tokenize = exports.number_ = exports.greedyNumber = exports.number = exports.whitespace = exports.punctuation = exports.greedyWord = exports.word = exports._greedyNumber = exports._greedyWord = exports._wordOrNumber = exports._number = exports._word = void 0;

var _xregexp = _interopRequireDefault(require("xregexp"));

var _occurrences2 = require("./occurrences");

var _normalizers = require("./normalizers");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

// constants
var _word = "[\\pL\\pM\\u200D\\u2060]+";
exports._word = _word;
var _number = '[\\pN\\pNd\\pNl\\pNo]+';
exports._number = _number;

var _wordOrNumber = '(' + _word + '|' + _number + ')';

exports._wordOrNumber = _wordOrNumber;

var _greedyWord = '(' + _wordOrNumber + '([-\'’]' + _word + ')+|' + _word + '’?)';

exports._greedyWord = _greedyWord;

var _greedyNumber = '(' + _number + '([:.,]?' + _number + ')+|' + _number + ')';

exports._greedyNumber = _greedyNumber;
var word = (0, _xregexp["default"])(_word, '');
exports.word = word;
var greedyWord = (0, _xregexp["default"])(_greedyWord, '');
exports.greedyWord = greedyWord;
var punctuation = (0, _xregexp["default"])('(^\\p{P}|[<>]{2})', '');
exports.punctuation = punctuation;
var whitespace = /\s+/;
exports.whitespace = whitespace;
var number = (0, _xregexp["default"])(_number);
exports.number = number;
var greedyNumber = (0, _xregexp["default"])(_greedyNumber); //  /(\d+([:.,]?\d)+|\d+)/;

exports.greedyNumber = greedyNumber;
var number_ = (0, _xregexp["default"])(number);
/**
 * Tokenize a string into an array of words
 * @param {Object} params - string to be tokenized
 * @return {Array} - array of tokenized words/strings
 */

exports.number_ = number_;

var tokenize = function tokenize(_ref) {
  var _ref$text = _ref.text,
      text = _ref$text === void 0 ? '' : _ref$text,
      _ref$includeWords = _ref.includeWords,
      includeWords = _ref$includeWords === void 0 ? true : _ref$includeWords,
      _ref$includeNumbers = _ref.includeNumbers,
      includeNumbers = _ref$includeNumbers === void 0 ? true : _ref$includeNumbers,
      _ref$includePunctuati = _ref.includePunctuation,
      includePunctuation = _ref$includePunctuati === void 0 ? false : _ref$includePunctuati,
      _ref$includeWhitespac = _ref.includeWhitespace,
      includeWhitespace = _ref$includeWhitespac === void 0 ? false : _ref$includeWhitespac,
      _ref$includeUnknown = _ref.includeUnknown,
      includeUnknown = _ref$includeUnknown === void 0 ? false : _ref$includeUnknown,
      _ref$greedy = _ref.greedy,
      greedy = _ref$greedy === void 0 ? false : _ref$greedy,
      _ref$verbose = _ref.verbose,
      verbose = _ref$verbose === void 0 ? false : _ref$verbose,
      _ref$occurrences = _ref.occurrences,
      occurrences = _ref$occurrences === void 0 ? false : _ref$occurrences,
      _ref$parsers = _ref.parsers,
      parsers = _ref$parsers === void 0 ? {
    word: word,
    whitespace: whitespace,
    punctuation: punctuation,
    number: number
  } : _ref$parsers,
      _ref$normalize = _ref.normalize,
      normalize = _ref$normalize === void 0 ? false : _ref$normalize,
      _ref$normalizations = _ref.normalizations,
      normalizations = _ref$normalizations === void 0 ? null : _ref$normalizations;
  var string = text.slice(0);
  if (normalize) string = (0, _normalizers.normalizer)(string);

  if (normalize && normalizations) {
    string = (0, _normalizers.normalizerDestructive)(string, normalizations);
  }

  var greedyParsers = _objectSpread({}, parsers, {
    word: greedyWord,
    number: greedyNumber
  });

  var _parsers = greedy ? greedyParsers : parsers;

  var tokens = classifyTokens(string, _parsers, 'unknown');
  var types = [];
  if (includeWords) types.push('word');
  if (includeNumbers) types.push('number');
  if (includeWhitespace) types.push('whitespace');
  if (includePunctuation) types.push('punctuation');
  if (includeUnknown) types.push('unknown');
  tokens = tokens.filter(function (token) {
    return types.includes(token.type);
  });

  if (occurrences) {
    tokens = tokens.map(function (token, index) {
      var _occurrences = (0, _occurrences2.occurrencesInTokens)(tokens, token.token);

      var _occurrence = (0, _occurrences2.occurrenceInTokens)(tokens, index, token.token);

      return _objectSpread({}, token, {
        occurrence: _occurrence,
        occurrences: _occurrences
      });
    });
  }

  if (verbose) {
    tokens = tokens.map(function (token) {
      delete token.matches;
      return token;
    });
  } else {
    tokens = tokens.map(function (token) {
      return token.token;
    });
  }

  return tokens;
};
/**
 * Tiny tokenizer - https://gist.github.com/borgar/451393
 * @param {String} string - string to be tokenized
 * @param {Object} parsers - { word:/\w+/, whitespace:/\s+/, punctuation:/[^\w\s]/ }
 * @param {String} deftok - type to label tokens that are not classified with the above parsers
 * @return {Array} - array of objects => [{ token:"this", type:"word" },{ token:" ", type:"whitespace" }, Object { token:"is", type:"word" }, ... ]
**/


exports.tokenize = tokenize;

var classifyTokens = function classifyTokens(string, parsers, deftok) {
  string = !string ? '' : string; // if string is undefined, make it an empty string

  if (typeof string !== 'string') {
    throw new Error("tokenizer.tokenize() string is not String: ".concat(string));
  }

  var m;
  var r;
  var t;
  var tokens = [];

  while (string) {
    t = null;
    m = string.length;
    var key = void 0;

    for (key in parsers) {
      if (Object.prototype.hasOwnProperty.call(parsers, key)) {
        r = parsers[key].exec(string); // try to choose the best match if there are several
        // where "best" is the closest to the current starting point

        if (r && r.index < m) {
          var token = r[0];
          t = {
            token: token,
            type: key,
            matches: r.slice(1)
          };
          m = r.index;
        }
      }
    }

    if (m) {
      // there is text between last token and currently
      // matched token - push that out as default or "unknown"
      tokens.push({
        token: string.substr(0, m),
        type: deftok || 'unknown'
      });
    }

    if (t) {
      // push current token onto sequence
      tokens.push(t);
    }

    string = string.substr(m + (t ? t.token.length : 0));
  }

  return tokens;
};

exports.classifyTokens = classifyTokens;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90b2tlbml6ZXJzLmpzIl0sIm5hbWVzIjpbIl93b3JkIiwiX251bWJlciIsIl93b3JkT3JOdW1iZXIiLCJfZ3JlZWR5V29yZCIsIl9ncmVlZHlOdW1iZXIiLCJ3b3JkIiwiZ3JlZWR5V29yZCIsInB1bmN0dWF0aW9uIiwid2hpdGVzcGFjZSIsIm51bWJlciIsImdyZWVkeU51bWJlciIsIm51bWJlcl8iLCJ0b2tlbml6ZSIsInRleHQiLCJpbmNsdWRlV29yZHMiLCJpbmNsdWRlTnVtYmVycyIsImluY2x1ZGVQdW5jdHVhdGlvbiIsImluY2x1ZGVXaGl0ZXNwYWNlIiwiaW5jbHVkZVVua25vd24iLCJncmVlZHkiLCJ2ZXJib3NlIiwib2NjdXJyZW5jZXMiLCJwYXJzZXJzIiwibm9ybWFsaXplIiwibm9ybWFsaXphdGlvbnMiLCJzdHJpbmciLCJzbGljZSIsImdyZWVkeVBhcnNlcnMiLCJfcGFyc2VycyIsInRva2VucyIsImNsYXNzaWZ5VG9rZW5zIiwidHlwZXMiLCJwdXNoIiwiZmlsdGVyIiwidG9rZW4iLCJpbmNsdWRlcyIsInR5cGUiLCJtYXAiLCJpbmRleCIsIl9vY2N1cnJlbmNlcyIsIl9vY2N1cnJlbmNlIiwib2NjdXJyZW5jZSIsIm1hdGNoZXMiLCJkZWZ0b2siLCJFcnJvciIsIm0iLCJyIiwidCIsImxlbmd0aCIsImtleSIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImV4ZWMiLCJzdWJzdHIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7OztBQUNBO0FBQ08sSUFBTUEsS0FBSyxHQUFHLDJCQUFkOztBQUNBLElBQU1DLE9BQU8sR0FBRyx3QkFBaEI7OztBQUNBLElBQU1DLGFBQWEsR0FBRyxNQUFNRixLQUFOLEdBQWMsR0FBZCxHQUFvQkMsT0FBcEIsR0FBOEIsR0FBcEQ7Ozs7QUFDQSxJQUFNRSxXQUFXLEdBQUcsTUFBTUQsYUFBTixHQUFzQixTQUF0QixHQUFr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aEIsTUFBQUEsTUFBTSxDQUFDRyxJQUFQLENBQVk7QUFDVkUsUUFBQUEsS0FBSyxFQUFFVCxNQUFNLENBQUM4QixNQUFQLENBQWMsQ0FBZCxFQUFpQlYsQ0FBakIsQ0FERztBQUVWVCxRQUFBQSxJQUFJLEVBQUVPLE1BQU0sSUFBSTtBQUZOLE9BQVo7QUFJRDs7QUFDRCxRQUFJSSxDQUFKLEVBQU87QUFDTDtBQUNBbEIsTUFBQUEsTUFBTSxDQUFDRyxJQUFQLENBQVllLENBQVo7QUFDRDs7QUFDRHRCLElBQUFBLE1BQU0sR0FBR0EsTUFBTSxDQUFDOEIsTUFBUCxDQUFjVixDQUFDLElBQUlFLENBQUMsR0FBR0EsQ0FBQyxDQUFDYixLQUFGLENBQVFjLE1BQVgsR0FBb0IsQ0FBekIsQ0FBZixDQUFUO0FBQ0Q7O0FBQ0QsU0FBT25CLE1BQVA7QUFDRCxDQTVDTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB4UmVnRXhwIGZyb20gJ3hyZWdleHAnO1xyXG5pbXBvcnQgeyBvY2N1cnJlbmNlSW5Ub2tlbnMsIG9jY3VycmVuY2VzSW5Ub2tlbnMgfSBmcm9tICcuL29jY3VycmVuY2VzJztcclxuaW1wb3J0IHsgbm9ybWFsaXplciwgbm9ybWFsaXplckRlc3RydWN0aXZlLCBub3JtYWxpemF0aW9uc0Rlc3RydWN0aXZlIH0gZnJvbSAnLi9ub3JtYWxpemVycyc7XHJcbi8vIGNvbnN0YW50c1xyXG5leHBvcnQgY29uc3QgX3dvcmQgPSAnW1xcXFxwTFxcXFxwTVxcXFx1MjAwRFxcXFx1MjA2MF0rJztcclxuZXhwb3J0IGNvbnN0IF9udW1iZXIgPSAnW1xcXFxwTlxcXFxwTmRcXFxccE5sXFxcXHBOb10rJztcclxuZXhwb3J0IGNvbnN0IF93b3JkT3JOdW1iZXIgPSAnKCcgKyBfd29yZCArICd8JyArIF9udW1iZXIgKyAnKSc7XHJcbmV4cG9ydCBjb25zdCBfZ3JlZWR5V29yZCA9ICcoJyArIF93b3JkT3JOdW1iZXIgKyAnKFstXFwn4oCZXScgKyBfd29yZCArICcpK3wnICsgX3dvcmQgKyAn4oCZPyknO1xyXG5leHBvcnQgY29uc3QgX2dyZWVkeU51bWJlciA9ICcoJyArIF9udW1iZXIgKyAnKFs6LixdPycgKyBfbnVtYmVyICsgJykrfCcgKyBfbnVtYmVyICsgJyknO1xyXG5leHBvcnQgY29uc3Qgd29yZCA9IHhSZWdFeHAoX3dvcmQsICcnKTtcclxuZXhwb3J0IGNvbnN0IGdyZWVkeVdvcmQgPSB4UmVnRXhwKF9ncmVlZHlXb3JkLCAnJyk7XHJcbmV4cG9ydCBjb25zdCBwdW5jdHVhdGlvbiA9IHhSZWdFeHAoJyheXFxcXHB7UH18Wzw+XXsyfSknLCAnJyk7XHJcbmV4cG9ydCBjb25zdCB3aGl0ZXNwYWNlID0gL1xccysvO1xyXG5leHBvcnQgY29uc3QgbnVtYmVyID0geFJlZ0V4cChfbnVtYmVyKTtcclxuZXhwb3J0IGNvbnN0IGdyZWVkeU51bWJlciA9IHhSZWdFeHAoX2dyZWVkeU51bWJlcik7IC8vICAvKFxcZCsoWzouLF0/XFxkKSt8XFxkKykvO1xyXG5leHBvcnQgY29uc3QgbnVtYmVyXyA9IHhSZWdFeHAobnVtYmVyKTtcclxuXHJcblxyXG4vKipcclxuICogVG9rZW5pemUgYSBzdHJpbmcgaW50byBhbiBhcnJheSBvZiB3b3Jkc1xyXG4gKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIC0gc3RyaW5nIHRvIGJlIHRva2VuaXplZFxyXG4gKiBAcmV0dXJuIHtBcnJheX0gLSBhcnJheSBvZiB0b2tlbml6ZWQgd29yZHMvc3RyaW5nc1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IHRva2VuaXplID0gKHtcclxuICB0ZXh0ID0gJycsXHJcbiAgaW5jbHVkZVdvcmRzID0gdHJ1ZSxcclxuICBpbmNsdWRlTnVtYmVycyA9IHRydWUsXHJcbiAgaW5jbHVkZVB1bmN0dWF0aW9uID0gZmFsc2UsXHJcbiAgaW5jbHVkZVdoaXRlc3BhY2UgPSBmYWxzZSxcclxuICBpbmNsdWRlVW5rbm93biA9IGZhbHNlLFxyXG4gIGdyZWVkeSA9IGZhbHNlLFxyXG4gIHZlcmJvc2UgPSBmYWxzZSxcclxuICBvY2N1cnJlbmNlcyA9IGZhbHNlLFxyXG4gIHBhcnNlcnMgPSB7IHdvcmQsIHdoaXRlc3BhY2UsIHB1bmN0dWF0aW9uLCBudW1iZXIgfSxcclxuICBub3JtYWxpemUgPSBmYWxzZSxcclxuICAvL25vcm1hbGl6YXRpb25zID0gbm9ybWFsaXphdGlvbnNEZXN0cnVjdGl2ZSxcclxuICBub3JtYWxpemF0aW9ucyA9IG51bGwsXHJcbn0pID0+IHtcclxuICBsZXQgc3RyaW5nID0gdGV4dC5zbGljZSgwKTtcclxuICBpZiAobm9ybWFsaXplKSBzdHJpbmcgPSBub3JtYWxpemVyKHN0cmluZyk7XHJcbiAgaWYgKG5vcm1hbGl6ZSAmJiBub3JtYWxpemF0aW9ucykge1xyXG4gICAgc3RyaW5nID0gbm9ybWFsaXplckRlc3RydWN0aXZlKHN0cmluZywgbm9ybWFsaXphdGlvbnMpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZ3JlZWR5UGFyc2VycyA9IHsgLi4ucGFyc2Vycywgd29yZDogZ3JlZWR5V29yZCwgbnVtYmVyOiBncmVlZHlOdW1iZXIgfTtcclxuICBjb25zdCBfcGFyc2VycyA9IGdyZWVkeSA/IGdyZWVkeVBhcnNlcnMgOiBwYXJzZXJzO1xyXG4gIGxldCB0b2tlbnMgPSBjbGFzc2lmeVRva2VucyhzdHJpbmcsIF9wYXJzZXJzLCAndW5rbm93bicpO1xyXG4gIGNvbnN0IHR5cGVzID0gW107XHJcbiAgaWYgKGluY2x1ZGVXb3JkcykgdHlwZXMucHVzaCgnd29yZCcpO1xyXG4gIGlmIChpbmNsdWRlTnVtYmVycykgdHlwZXMucHVzaCgnbnVtYmVyJyk7XHJcbiAgaWYgKGluY2x1ZGVXaGl0ZXNwYWNlKSB0eXBlcy5wdXNoKCd3aGl0ZXNwYWNlJyk7XHJcbiAgaWYgKGluY2x1ZGVQdW5jdHVhdGlvbikgdHlwZXMucHVzaCgncHVuY3R1YXRpb24nKTtcclxuICBpZiAoaW5jbHVkZVVua25vd24pIHR5cGVzLnB1c2goJ3Vua25vd24nKTtcclxuICB0b2tlbnMgPSB0b2tlbnMuZmlsdGVyKCh0b2tlbikgPT4gdHlwZXMuaW5jbHVkZXModG9rZW4udHlwZSkpO1xyXG4gIGlmIChvY2N1cnJlbmNlcykge1xyXG4gICAgdG9rZW5zID0gdG9rZW5zLm1hcCgodG9rZW4sIGluZGV4KSA9PiB7XHJcbiAgICAgIGNvbnN0IF9vY2N1cnJlbmNlcyA9IG9jY3VycmVuY2VzSW5Ub2tlbnModG9rZW5zLCB0b2tlbi50b2tlbik7XHJcbiAgICAgIGNvbnN0IF9vY2N1cnJlbmNlID0gb2NjdXJyZW5jZUluVG9rZW5zKHRva2VucywgaW5kZXgsIHRva2VuLnRva2VuKTtcclxuICAgICAgcmV0dXJuIHsgLi4udG9rZW4sIG9jY3VycmVuY2U6IF9vY2N1cnJlbmNlLCBvY2N1cnJlbmNlczogX29jY3VycmVuY2VzIH07XHJcbiAgICB9KTtcclxuICB9XHJcbiAgaWYgKHZlcmJvc2UpIHtcclxuICAgIHRva2VucyA9IHRva2Vucy5tYXAoKHRva2VuKSA9PiB7XHJcbiAgICAgIGRlbGV0ZSB0b2tlbi5tYXRjaGVzO1xyXG4gICAgICByZXR1cm4gdG9rZW47XHJcbiAgICB9KTtcclxuICB9IGVsc2Uge1xyXG4gICAgdG9rZW5zID0gdG9rZW5zLm1hcCgodG9rZW4pID0+IHRva2VuLnRva2VuKTtcclxuICB9XHJcbiAgcmV0dXJuIHRva2VucztcclxufTtcclxuXHJcbi8qKlxyXG4gKiBUaW55IHRva2VuaXplciAtIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tL2Jvcmdhci80NTEzOTNcclxuICogQHBhcmFtIHtTdHJpbmd9IHN0cmluZyAtIHN0cmluZyB0byBiZSB0b2tlbml6ZWRcclxuICogQHBhcmFtIHtPYmplY3R9IHBhcnNlcnMgLSB7IHdvcmQ6L1xcdysvLCB3aGl0ZXNwYWNlOi9cXHMrLywgcHVuY3R1YXRpb246L1teXFx3XFxzXS8gfVxyXG4gKiBAcGFyYW0ge1N0cmluZ30gZGVmdG9rIC0gdHlwZSB0byBsYWJlbCB0b2tlbnMgdGhhdCBhcmUgbm90IGNsYXNzaWZpZWQgd2l0aCB0aGUgYWJvdmUgcGFyc2Vyc1xyXG4gKiBAcmV0dXJuIHtBcnJheX0gLSBhcnJheSBvZiBvYmplY3RzID0+IFt7IHRva2VuOlwidGhpc1wiLCB0eXBlOlwid29yZFwiIH0seyB0b2tlbjpcIiBcIiwgdHlwZTpcIndoaXRlc3BhY2VcIiB9LCBPYmplY3QgeyB0b2tlbjpcImlzXCIsIHR5cGU6XCJ3b3JkXCIgfSwgLi4uIF1cclxuKiovXHJcbmV4cG9ydCBjb25zdCBjbGFzc2lmeVRva2VucyA9IChzdHJpbmcsIHBhcnNlcnMsIGRlZnRvaykgPT4ge1xyXG4gIHN0cmluZyA9ICghc3RyaW5nKSA/ICcnIDogc3RyaW5nOyAvLyBpZiBzdHJpbmcgaXMgdW5kZWZpbmVkLCBtYWtlIGl0IGFuIGVtcHR5IHN0cmluZ1xyXG4gIGlmICh0eXBlb2Ygc3RyaW5nICE9PSAnc3RyaW5nJykge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKGB0b2tlbml6ZXIudG9rZW5pemUoKSBzdHJpbmcgaXMgbm90IFN0cmluZzogJHtzdHJpbmd9YCk7XHJcbiAgfVxyXG4gIGxldCBtO1xyXG4gIGxldCByO1xyXG4gIGxldCB0O1xyXG4gIGxldCB0b2tlbnMgPSBbXTtcclxuICB3aGlsZSAoc3RyaW5nKSB7XHJcbiAgICB0ID0gbnVsbDtcclxuICAgIG0gPSBzdHJpbmcubGVuZ3RoO1xyXG4gICAgbGV0IGtleTtcclxuICAgIGZvciAoa2V5IGluIHBhcnNlcnMpIHtcclxuICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChwYXJzZXJzLCBrZXkpKSB7XHJcbiAgICAgICAgciA9IHBhcnNlcnNba2V5XS5leGVjKHN0cmluZyk7XHJcbiAgICAgICAgLy8gdHJ5IHRvIGNob29zZSB0aGUgYmVzdCBtYXRjaCBpZiB0aGVyZSBhcmUgc2V2ZXJhbFxyXG4gICAgICAgIC8vIHdoZXJlIFwiYmVzdFwiIGlzIHRoZSBjbG9zZXN0IHRvIHRoZSBjdXJyZW50IHN0YXJ0aW5nIHBvaW50XHJcbiAgICAgICAgaWYgKHIgJiYgKHIuaW5kZXggPCBtKSkge1xyXG4gICAgICAgICAgbGV0IHRva2VuID0gclswXTtcclxuICAgICAgICAgIHQgPSB7XHJcbiAgICAgICAgICAgIHRva2VuLFxyXG4gICAgICAgICAgICB0eXBlOiBrZXksXHJcbiAgICAgICAgICAgIG1hdGNoZXM6IHIuc2xpY2UoMSksXHJcbiAgICAgICAgICB9O1xyXG4gICAgICAgICAgbSA9IHIuaW5kZXg7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAobSkge1xyXG4gICAgICAvLyB0aGVyZSBpcyB0ZXh0IGJldHdlZW4gbGFzdCB0b2tlbiBhbmQgY3VycmVudGx5XHJcbiAgICAgIC8vIG1hdGNoZWQgdG9rZW4gLSBwdXNoIHRoYXQgb3V0IGFzIGRlZmF1bHQgb3IgXCJ1bmtub3duXCJcclxuICAgICAgdG9rZW5zLnB1c2goe1xyXG4gICAgICAgIHRva2VuOiBzdHJpbmcuc3Vic3RyKDAsIG0pLFxyXG4gICAgICAgIHR5cGU6IGRlZnRvayB8fCAndW5rbm93bicsXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKHQpIHtcclxuICAgICAgLy8gcHVzaCBjdXJyZW50IHRva2VuIG9udG8gc2VxdWVuY2VcclxuICAgICAgdG9rZW5zLnB1c2godCk7XHJcbiAgICB9XHJcbiAgICBzdHJpbmcgPSBzdHJpbmcuc3Vic3RyKG0gKyAodCA/IHQudG9rZW4ubGVuZ3RoIDogMCkpO1xyXG4gIH1cclxuICByZXR1cm4gdG9rZW5zO1xyXG59O1xyXG5cclxuIl19